___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "categories": ["UTILITY"],
  "securityGroups": [],
  "displayName": "CMP（ITP対応）",
  "brand": {
    "id": "intimatemerger",
    "displayName": "IntimateMerger",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "CMPの許諾情報を永続化します",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "expiration",
    "displayName": "有効期限",
    "simpleValueType": true,
    "defaultValue": 86400000,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "POSITIVE_NUMBER"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "settings",
    "displayName": "設定",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "clientCookieName",
        "displayName": "Consent Cookie Name",
        "simpleValueType": true,
        "defaultValue": "_im_consent",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "serverCookieName",
        "displayName": "Saved Cookie Name",
        "simpleValueType": true,
        "defaultValue": "_im_consents",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "CHECKBOX",
        "name": "httpOnly",
        "checkboxText": "HTTP Only",
        "simpleValueType": true
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const getRequestHeader = require('getRequestHeader');
const computeEffectiveTldPlusOne = require('computeEffectiveTldPlusOne');
const setCookie = require('setCookie');
const getCookieValues = require('getCookieValues');

let host = getRequestHeader('host');
let value = getCookieValues(data.clientCookieName, true)[0];

if (host && value) {
  let domain = computeEffectiveTldPlusOne(host);
  let options = {
    domain: domain,
    path: "/",
    secure: true
  }; 
  if (data.expiration > 0) {
    options['max-age'] = data.expiration;
  }
  if (data.httpOnly) {
    options.HttpOnly = data.httpOnly;
  }
  setCookie(data.serverCookieName, value, options, true);
}

data.gtmOnSuccess();


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []
setup: ''


___NOTES___

Created on 2022/2/15 3:28:54


